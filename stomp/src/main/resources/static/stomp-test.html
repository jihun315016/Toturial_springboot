<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>STOMP 테스트 클라이언트</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.0/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        #status { font-weight: bold; }
        .connected { color: green; }
        .disconnected { color: red; }
        #messages { list-style: none; padding: 0; }
        #messages li { margin-bottom: 5px; padding: 5px; border-bottom: 1px solid #eee; }
    </style>
</head>
<body>

<h2>STOMP WebSocket 테스트 클라이언트</h2>

<div id="login-area">
    <h3>로그인 및 토큰 확보</h3>
    <p>테스트용 토큰을 발급받습니다.</p>
    <button onclick="loginAndGetToken()">테스트 로그인</button>
    <p>현재 토큰: <span id="jwt-token" style="color: blue;">로그인 전</span></p>
</div>

<hr/>

<div id="status-area">
    <p>연결 상태: <span id="status" class="disconnected">연결 끊김</span></p>
    <label for="room-id">테스트 Room ID:</label>
    <input type="text" id="room-id" value="100">
    <button onclick="connect()">연결 및 구독</button>
    <button onclick="disconnect()">연결 끊기</button>
</div>

<hr/>

<div id="message-area">
    <h3>메시지 전송</h3>
    <label for="sender-email">보내는 이 (Email):</label>
    <input type="text" id="sender-email" placeholder="test@test.com"> <br><br>
    <label for="message-input">메시지:</label>
    <input type="text" id="message-input" placeholder="전송할 메시지">
    <button onclick="sendMessage()" disabled id="send-btn">전송</button>
</div>

<hr/>

<div id="log-area">
    <h3>수신 메시지 로그</h3>
    <ul id="messages"></ul>
</div>

<script>
    let stompClient = null;
    let currentToken = null;

    const ENDPOINT = '/connect'; // config: .addEndpoint("/connect")
    const SUBSCRIBE_PREFIX = '/topic/'; // config: .enableSimpleBroker("/topic")
    const PUBLISH_PREFIX = '/publish/'; // config: .setApplicationDestinationPrefixes("/publish")

    function loginAndGetToken() {
        // 실제 백엔드에 로그인 엔드포인트가 있다고 가정
        $.post("/user/login", function(data) {
            if (data.token) {
                currentToken = data.token;
                $("#jwt-token").text(currentToken.substring(0, 30) + "...");
                alert("토큰 획득 성공!");
            }
        }).fail(function() {
            alert("로그인 API 호출 실패. (URL 확인 필요)");
        });
    }

    function setConnected(connected) {
        $("#status").text(connected ? "연결됨" : "연결 끊김")
            .toggleClass("connected", connected)
            .toggleClass("disconnected", !connected);
        $("#send-btn").prop("disabled", !connected);
    }

    function connect() {
        // ⭐️ 추가: 이미 연결된 상태라면 중복 연결/구독 방지
        if (stompClient !== null && stompClient.connected) {
            console.log("이미 연결된 상태입니다.");
            return;
        }

        if (!currentToken) {
            alert("로그인을 먼저 해주세요."); return;
        }

        const socket = new SockJS(ENDPOINT);
        stompClient = Stomp.over(socket);

        const headers = { 'Authorization': 'Bearer ' + currentToken };

        stompClient.connect(headers, function (frame) {
            setConnected(true);
            const roomId = $("#room-id").val();

            // ⭐️ 중요: 기존 구독을 방지하기 위해 connect 시점에만 1회 호출됨을 보장
            stompClient.subscribe(SUBSCRIBE_PREFIX + roomId, function (messageOutput) {
                const body = JSON.parse(messageOutput.body);
                showMessage(body, roomId);
            });
        });
    }

    function disconnect() {
        if (stompClient !== null) {
            stompClient.disconnect();
        }
        setConnected(false);
    }

    function sendMessage() {
        const roomId = $("#room-id").val();
        const messageText = $("#message-input").val();
        const sender = $("#sender-email").val() || "unknown@user.com";

        if (!messageText) return;

        // ⭐️ 중요: ChatMessageReqDto 규격에 맞춰 JSON 객체 전송
        const payload = {
            message: messageText,
            senderEmail: sender
        };

        // 전송 경로: /publish/{roomId} (Controller의 @MessageMapping("/{roomId}"))
        stompClient.send(PUBLISH_PREFIX + roomId, {}, JSON.stringify(payload));
        $("#message-input").val("");
    }

    function showMessage(data, roomId) {
        $("#messages").append("<li><strong>[" + data.senderEmail + "]:</strong> " + data.message + "</li>");
    }
</script>
</body>
</html>